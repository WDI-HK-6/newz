app.controller("fbCtrl", ['$scope', '$upload', 'fileReader', function($scope, $upload, fileReader){

  // $scope.post = [{id:1,title:"title1",content:"content1",caption:"caption1"},{id:2,title:"title2",content:"content2",caption:"caption2"}];

  var sendToFB = function(picture_link){
    console.log("in FB send");
    FB.ui({
        method: 'feed',
        name: 'Birthday Newz',
        link: picture_link,
        picture: picture_link,
        caption: 'Birthday Newz',
        description: '',
        message: ''
    });
  };

  // *****************************
  // AWS S3 UPLOAD STUFF
  $scope.share = function() {  
    
    var bucket = 'birthday-newz';
    var url = 'https://s3.amazonaws.com/' + bucket + '/';

    html2canvas($("#newspaper"), {
      allowTaint: true,
      useCORS: true,
      // taintTest: false,
      logging: true,
      onrendered: function (canvas) {
        var randomID = Math.floor(Math.random() * 100000000);

        var img = canvas.toDataURL('image/png');
        var blob = dataURItoBlob(img);

        // try sending a formdata object to s3
        var formData = doForm(blob, randomID);
        var xhr = new XMLHttpRequest();

        //xhr.upload.addEventListener("progress", uploadProgress, false);
        //xhr.addEventListener("load", uploadComplete, false);
        // xhr.addEventListener("error", uploadFailed, false);
        // xhr.addEventListener("abort", uploadCanceled, false);

        xhr.open('POST', url, true); 

        xhr.send(formData); 

        var card_url = url + randomID;
        console.log(card_url);
        sendToFB(card_url);

        // var img = new Image();
        // img.src = canvas.toDataURL('image/jpg');
        // var imgName = randomID + ".jpg";

        // console.log("name is "+imgName);

        // $scope.card_url = upload(fd, imgName);
        // console.log("return is "+ $scope.card_url);

      }
    });
  }

  var doForm = function(blob, filename) {
    var accessKey = 'AKIAJ7UNHWBS5OZKZG7A';
    var policy = 'ewogICJleHBpcmF0aW9uIjogIjIwMjAtMDEtMDFUMDA6MDA6MDBaIiwKICAiY29uZGl0aW9ucyI6IFsKICAgIHsiYnVja2V0IjogImJpcnRoZGF5LW5ld3oifSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJGtleSIsICIiXSwKICAgIHsiYWNsIjogInByaXZhdGUifSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJENvbnRlbnQtVHlwZSIsICIiXSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJGZpbGVuYW1lIiwgIiJdLAogICAgWyJjb250ZW50LWxlbmd0aC1yYW5nZSIsIDAsIDUyNDI4ODAwMF0KICBdCn0=';
    var signature = 'Q+xxfE8tkHNfoPgNu1v5+5uUtFc=';

    var fd = new FormData();

    fd.append('AWSAccessKeyId', accessKey);
    fd.append('key', filename);
    fd.append('filename', filename + ".jpg");
    fd.append('acl', 'private');
    fd.append('Content-Type', "image/jpeg");
    fd.append('policy', policy);
    fd.append('signature', signature);          
    fd.append('file',  blob);

    return fd;
  }

  var upload = function(file, filename) {
    var uploadUrl = 'https://birthday-newz.s3.amazonaws.com/';
    if (file) {
      $upload.upload({
        url: uploadUrl,
        fields: {
          AWSAccessKeyId: 'AKIAJ7UNHWBS5OZKZG7A',
          key: filename,
          filename: filename,
          acl: 'private',
          'Content-Type': '',
          policy: 'ewogICJleHBpcmF0aW9uIjogIjIwMjAtMDEtMDFUMDA6MDA6MDBaIiwKICAiY29uZGl0aW9ucyI6IFsKICAgIHsiYnVja2V0IjogImJpcnRoZGF5LW5ld3oifSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJGtleSIsICIiXSwKICAgIHsiYWNsIjogInByaXZhdGUifSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJENvbnRlbnQtVHlwZSIsICIiXSwKICAgIFsic3RhcnRzLXdpdGgiLCAiJGZpbGVuYW1lIiwgIiJdLAogICAgWyJjb250ZW50LWxlbmd0aC1yYW5nZSIsIDAsIDUyNDI4ODAwMF0KICBdCn0=',
          signature: 'Q+xxfE8tkHNfoPgNu1v5+5uUtFc='
        },                      
        file: file
      }).progress(function (evt) {
        var progressPercentage = parseInt(100.0 * evt.loaded / evt.total);
        $scope.progress = progressPercentage;
        console.log('progress: ' + progressPercentage + '% ' + evt.config.file.name);
      }).success(function (data, status, headers, config) {
        console.log(config);
        console.log('file ' + config.fields.filename + 'uploaded. Response: ' + status + data);
        uploadUrl + config.fields.filename;
      });
    }
  };

  function dataURItoBlob(dataURI) {
      // convert base64/URLEncoded data component to raw binary data held in a string
      var byteString;
      if (dataURI.split(',')[0].indexOf('base64') >= 0)
          byteString = atob(dataURI.split(',')[1]);
      else
          byteString = unescape(dataURI.split(',')[1]);

      // separate out the mime component
      var mimeString = dataURI.split(',')[0].split(':')[1].split(';')[0];

      // write the bytes of the string to a typed array
      var ia = new Uint8Array(byteString.length);
      for (var i = 0; i < byteString.length; i++) {
          ia[i] = byteString.charCodeAt(i);
      }
      return new Blob([ia], {type:mimeString});
  }

}])

  // select file for image upload
  // github.com/danialfarid/angular-file-upload/wiki/Rails-Example
  // $scope.upload = $upload.upload({
  //   // url: '/card/new',
  //   url: 'https://s3.amazonaws.com/newz-images/',
  //   method: 'POST',
  //   file: $scope.card.image,
  //   // key: $scope.card.image,
  //   AWSAccessKeyId: "AKIAJACNEVDWYZCMXGSQ",
  //   // acl: $scope.policy,
  //   // signature: $scope.signature,
  //   // "Content-Type": file.type != '' ? file.type : 'application/octet-stream', 
  //   // fileFormDataName: 'Card['+$scope.card.image+']',
  //   //myEntity is the name of the entity in which image is saved and image is the name of the attachment
  //   fields: {}
  // }).success(function(data, status, headers, config) {
  //   console.log('file ' + config.file.name + 'uploaded. Response: ' + data);
  //   console.log("SOME SUCCESS HERE");
  // }).error(function(response) {
  //   console.log(response);
  //   console.log("ANOTHER FN ERROR");
  // });

  // $scope.$watch('files', function () {
  //   $scope.upload($scope.files);
  // });
