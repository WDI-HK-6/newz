app.controller('HomeCtrl', ['$scope', '$http', '$rootScope', '$timeout', function($scope, $http, $rootScope, $timeout){

  $scope.feature = {
    heading: "Your heading",
    author: "author (you)",
    article_text: "Put a birthday message here"
  };

  $scope.minDate = new Date("1946-01-01");
  $scope.maxDate = new Date();

  $scope.open = function($event) {
    $event.preventDefault();
    $event.stopPropagation();
    $scope.opened = true;
  };
  $scope.dateOptions = {
    'year-format': "'yy'",
    'starting-day': 1
  };

  $scope.print = function() {
    // var printContents = document.getElementById("newspaper").innerHTML;
    // var originalContents = document.body.innerHTML;
    // var $stamp = $container.find('.item')

    // $container.packery( 'stamp', $stamp )
    // $scope.repack();
    // $('body .site-container').css({display:'none'});
    // var content = $("#newspaper").clone();
    // $('body .site-container').before(content);
    // $('.col-xs-3.form-column.top-margin')
    window.print();
    // $("#newspaper").first().remove();
    // $('body .site-container').css({display:''});
    // $container.packery( 'unstamp', $stamp )
    // document.body.innerHTML = printContents;
    // window.print();
    // window.close();
    // // window.onfocus=function(){ window.close();}
    // document.body.innerHTML = originalContents;
    // setTimeout(function(){window.close();}, 1);
  }

  $scope.selectDate = function(date) {
    year = moment(date).format('YYYY');
    getNews(year);
    getFacts(date);
    getHoroscopes(date);
    getMovies(year);
    getSongs(year);  
    $scope.repack();
  }

  var getSongs = function(year) {
    $http.get('songlists/' + year + '.json').success(function(data){
      $scope.card.songlist = data['songlist'];
    })
  }

  var getMovies = function(year) {
    $http.get('movies/' + year + '.json').success(function(data){
      $scope.card.movie = data.movie[0]["bestMovie"];
      $scope.card.producers = data.movie[0]["producers"];
      $scope.card.nominees = data.movie[0]["nominees"];
      $scope.card.producersExist = data.movie[0]["producersExist"];
      $scope.card.bestActor = data.movie[0]["bestActor"];
      $scope.card.bestActress = data.movie[0]["bestActress"];
      $scope.card.bestActorMovie = data.movie[0]["bestActorMovie"];
      $scope.card.bestActressMovie = data.movie[0]["bestActressMovie"];
    })
  }

  var getNews = function(year) {
    $http.get('news/' + year + '.json').success(function(data){
      console.log(data);
      // an array like producers
      $scope.card.news = data.newsarticles["news"];
      // $scope.card.sports = data.result[0]["sports"];
      // $scope.card.other = data.result[0]["other"];
    })
  }

  var getFacts = function(date) {
    newDate = moment(date).format("YYYY-M-DD");  
    $http.get('facts/' + newDate).success(function(data){
      $scope.card.gold = data.gold;
      $scope.card.dowjones = data.dowjones;
      $scope.card.homeprice = data.homeprice;
      $scope.card.newcar = data.newcar;
      $scope.card.bread = data.bread;
      $scope.card.gas = data.gas;
      $scope.card.population = data.population;
    })
  }

  var getHoroscopes = function(date) {
    newDate = moment(date).format("YYYY-M-DD");  
    $http.get('zodiac/' + newDate).success(function(data){
      $scope.card.zodiac = data.zodiacDesc;
      $scope.card.zodiacName = data.zodiacName;
      $scope.card.chinese_horoscope = data.animalDesc;
      $scope.card.animalName = data.animalName;
    })
  }

  $scope.repack = function() {
    $scope.$container.packery();
    console.log("Just repacked");
    // $scope.$container.bindResize();
  }

  $scope.$container = $('#container');
  // init
  $scope.$container.packery({
    itemSelector: '.item',
    // "gutter": 10,
    "columnWidth": ".grid-sizer",
    "stamp": ".stamp",
    "columnHeight": ".grid-sizer"
    // "gutter": ".gutter-sizer",
    // isInitLayout: false
  });

  $scope.imgLoadedEvents = {
    always: function(instance) {
            // Do stuff
      // console.log("images always");
      console.log("images all loaded");
      $timeout(function(){
        $scope.repack();
      }, 1500)
    }
  }

  $scope.$container.find('.item').each( function( i, itemElem ) {
    // make element draggable with Draggabilly
    //var draggie = new Draggabilly( itemElem );
    // bind Draggabilly events to Packery
    //$scope.$container.packery( 'bindDraggabillyEvents', draggie );
  });

  $scope.card = {};
  $scope.card.date = new Date("October 13, 1980 11:13:00");
  // edition is current year - 2015 + 1
  yearInt = parseInt(moment($scope.maxDate).format("YYYY"));
  $scope.card.edition  = yearInt - 2014;
  $scope.selectDate($scope.card.date);

}])

